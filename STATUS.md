# Debugging Status: Card Sale Reconciliation

**Date:** 2025-10-03

## 1. Initial Problem

The user reported that after importing ManaBox scans (creating `CardLot` records) and Cardmarket sales data (creating `SELL` transactions), the transactions were not being linked to the lots. This resulted in an incorrect "Sold Value" in the Box Evaluation view.

## 2. Debugging and Changes

Our debugging process involved several steps, focusing on the `ReconcilerService` and the `ImportService`.

### Attempt 1: Fixing the Reconciler's Date Logic

*   **Finding:** The reconciler was filtering out valid lots because the sale date from the Cardmarket CSV (e.g., August 2025) was earlier than the lot's purchase date, which was being set to the import time (e.g., October 2025).
*   **Change:** In `src/features/scans/ReconcilerService.ts`, the `reconcileSellsToLots` function was modified to remove the strict date check, allowing it to find lots regardless of their purchase date.
*   **Outcome:** The issue persisted.

### Attempt 2: Improving Reconciler Robustness

*   **Finding:** The logic comparing the card's language was case-sensitive (e.g., `'en'` vs `'EN'`), which could cause matches to fail silently.
*   **Change:** In `src/features/scans/ReconcilerService.ts`, the `findLotsByIdentity` function was updated to perform a case-insensitive comparison for the language.
*   **Outcome:** The issue persisted.

### Attempt 3: Adding Debug Logs

*   **Finding:** With the logical fixes not working, we needed more visibility.
*   **Change:** Added extensive `console.debug` statements throughout `reconcileSellsToLots`, `findLotsByIdentity`, and `remainingQty` to provide a detailed trace of the reconciler's execution in the browser console.

### Attempt 4: Fixing the Reconciler Trigger

*   **Finding:** A new log from the user revealed that none of the debug logs were appearing. This led to the critical insight that the entire reconciliation process was not being triggered after a Cardmarket import.
*   **The Cause:** The `CardmarketImportWizard.vue` component was calling a legacy `importCardmarketArticles` method in `ImportService.ts`. This method had its own fragile mechanism for triggering the reconciler, which was being skipped due to silent errors during the import process.
*   **Change:** Refactored the `importCardmarketArticles` method in `src/features/imports/ImportService.ts` to use the modern, more reliable `ImportPipelines.importCardmarketSells` function. This new pipeline guarantees that the reconciler is triggered.

## 3. Current Status

Despite the major refactoring in Attempt 4, the user reports that the issue **still persists**. 

The code now contains:
1.  A refactored import process that should reliably trigger the reconciler.
2.  Robust matching logic within the reconciler (flexible dates, case-insensitive).
3.  Extensive debug logging to trace the entire process.

## 4. Next Steps

The immediate next step is to **analyze the browser console log** generated by the latest version of the code. The presence (or absence) of the `[reconcileSellsToLots]` debug logs will tell us definitively if the reconciler is finally running. 

- **If the logs appear:** We must analyze their output to see where the matching logic is failing inside the reconciler.
- **If the logs do not appear:** There is still a problem in the import pipeline that prevents the reconciler from being triggered, and we need to re-examine the `CardmarketImportWizard.vue` and `ImportService.ts` interaction.
